# Publish / Subscribe

- pub/sub 모델에서는 메시지를 송신하는 클라이언트(publisher: 발행자)를 메시지를 수신하는 클라이언트(subscribers: 구독자)로부터 분리한다.
- 발행자와 구독자는 서로의 존재를 모른다: 둘 사이의 연결은 3자(broker: 중개자)에 의해 다루어진다.
- 분리(decoupling)은 더 빠르고 효율적인 통신 과정을 산출한다.
- 발행자와 구독자 간의 직접 통신의 필요성을 제거하여, pub/sub 아키텍처는 IP 주소와 포트 교환을 하지 않는다.
  - 또한 이는 분리를 제공하여 발행 또는 수신 과정 중 양쪽 구성요소의 동작이 방해받지 않도록 한다.

## Pub/Sub 아키텍처의 특징

- Space decoupling: 발행자와 구독자는 서로를 모른다. (IP주소와 포트 교환 없음)
- Time decoupling: 발행자와 구독자는 같은 시간에 동작하지 않아도 된다.
- Synchronization decoupling: 두 요소의 동작은 발행이나 수신 도중에 방해받지 않는다.

Pub/Sub 소프트웨어 아키텍처의 가장 중요한 이점 중 하나는 들어오는 모든 메시지를 필터링해 구독자에게 올바르게 분배하는 능력이다. 이 때문에 발행자와 구독자가 서로의 존재를 알 필요가 없다.

### MQTT 프로토콜에서의 Pub/Sub 분리

- MQTT는 발행자와 구독자를 공간적으로 분리한다.
- 메시지를 발행하거나 수신하려면, 발행자와 구독자는 중개자의 호스트 이름/IP와 포트만 알면 된다.
- MQTT는 시간에 의해 분리된다. 대부분의 MQTT가 거의 실제 시간에 메시지를 전달하는 경우를 사용하지만, 원한다면 중개자는 접속 중이 아닌 클라이언트를 위해 메시지를 저장할 수도 있다. (두 가지 조건을 충족해야 메시지를 저장할 수 있다: 클라이언트는 지속적인 세션에 연결되어 있어야 하며, 0보다 큰 서비스 품질(Quality of Service: QoS)를 가지는 주제를 구독해야 한다.)

## Message Filtering

메시지 필터링은 구독자가 관심있는 메시지만 수신하도록 하기 때문에 pub/sub 아키텍처에서 필수적인 요소이다. pub/sub 중개자는 구독자 각각이 관심 있는 메시지만 받을 수 있도록 메시지 필터링을 관리하는 여러 필터링 옵션을 가진다.

1. Subject-based

    - 가장 일반적인 옵션
    - 이 필터링은 각 메시지의 주제에 기반한다.
    - 구독자가 특정 주제를 구독하면, 중개자가 주제 계층에 기반하여 적절한 구독자에게 메시지를 수신할 수 있도록 한다.
    - 주제 구조는 `/`로 구분된 레벨을 가진 계층 구조이며, 구독자가 구체적인 주제 레벨이나 주제 계층에 맞는 메시지를 수신하게 해준다.
    - 발행자와 구독자 둘 다 어떤 주제를 사용할지를 알아야 한다.
    - 메시지 전달 문제에 있어서, 발행자는 송신한 메시지를 누가 받았다고 가정하면 안된다.
      - 발행자는 구독자가 누구인지, 중개자와 현재 연결되어 있는지를 모르는 상태로 중개자에게 메시지를 전송한다.
      - 중개자는 적절한 주제를 구독한 모든 연결된 구독자에게 메시지를 전달하는 책임이 있다.
      - 그런데 특정 메시지의 주제를 구독한 구독자가 현재 중개자와 연결되어 있지 않다면 그 메시지는 누구에게도 전달되지 않는다. 그러므로, 발행자는 메시지 전달이 보장되지 않았다는 것을 염두에 두고 시스템을 설계해야 한다.

    1. 주제 기반 필터링의 이점

        - 사용하기 단순하고 쉽다.
        - 유연하며, 계층 주제 구조를 허용한다.
        - 특정 주제에 관심이 있는 구독자에게만 메시지를 넘기기 때문에 효율적이다.

    2. 주제 기반 필터링의 단점

        - 발행자와 구독자가 미리 주제 계층에 동의해야 한다.
        - 주제 계층에 한해서만 메시지를 필터링할 수 있다.

    3. MQTT

        - MQTT는 주제 기반의 메시지 필터링을 사용한다. 모든 메시지는 중개자가 구독자의 메시지 수신 여부를 결정하기 위해 사용할 수 있는 주제를 가진다.
        - MQTT는 세 개의 서비스 품질 수준을 가진다. 메시지가 성공적으로 클라이언트에서 중개자로, 또는 중개자에서 클라이언트로 전달되는지를 구체화할 수 있다. 그러나 누구도 특정 주제를 구독하지 않을 가능성도 있다. 이것이 문제라면, 중개자는 그런 경우를 어떻게 다루는지를 알아야 한다.
        - 중개자가 동작하게 하거나 단순히 기록 분석을 위해 데이터베이스에 모든 메시지를 기록하게 할 수도 있다.
        - 계층 주제 트리를 유연하게 유지하려면, 주제 트리를 매우 주의해서 설계해야 하며, 미래의 사용 사례를 위한 공간을 남겨야 한다.

2. Content-based

    - 중개자는 필터 표현식을 통해 구체화된 내용을 기반으로 메시지를 필터링한다.
    - 구독자는 구체적인 필터 표현식을 구독하고, 중개자는 메시지의 내용에 기반해 적절한 구독자에게 메시지를 전달한다.

    1. 내용 기반 필터링의 이점

        - 어느 메시지가 수신되었는지에 관한 더 세밀한 제어를 제공한다.
        - 단순히 주제 계층에 기반한 것이 아닌 메시지 내용에 기반한 필터링을 허용한다.
        - 유연하여 복잡한 필터 표현식을 허용한다.

    2. 내용 기반 필터링의 단점

        - 주제 기반 필터링보다 사용과 설정이 복잡할 수 있다.
        - 필터링을 위해 구독자가 메시지에 추가적인 메타데이터를 포함시켜야 한다.
        - 많은 양의 필터 표현식을 처리할 때 성능이 떨어질 수 있다.

3. Type-based

    - 중개자는 메시지의 타입이나 클래스에 기반해 메시지를 필터링한다.
    - 이 방식은 메시지가 객체로 표현되는 객체 지향 언어와 함께 사용할 때 유용하다.
    - 구독자가 특정 메시지 타입이나 클래스를 구독하면, 중개자는 메시지 타입에 기반해 적절한 구독자에게 메시지를 전달한다.

    1. 타입 기반 필터링의 이점

        - 주제나 내용과는 관계없이 메시지 타입에 기반하여 필터링한다.
        - 사용하기 단순한 편인데, 특히 객체 지향 언어와 함께 사용할 때 그렇다.
        - 높은 수준의 유연성과 확장성 제공

    2. 타입 기반 필터링의 단점

        - 메시지 타입에 한정된 필터링
        - 구독자와 발행자가 데이터가 발행되기 전에 메시지 타입 계층에 관해 합의해야 한다.

## 차이: MQTT & Message Queues

- 메시지 큐에서는 각각의 들어오는 메시지는 클라리언트가 고를 때까지 큐에 저장된다.
- 전통적인 메시지 큐에서는 메시지는 오직 하나의 소비자에 의해서만 가공될 수 있다.
- 큐는 명명되어야 하며 반드시 명시적으로 생성되어야 한다.
